<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Faculty - Hallmate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h1 class="mb-4 fw-bold text-center">Manage Faculty</h1>

    <div id="toastBox" class="toast-container"></div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white fw-bold">Add Faculty (Creates Login)</div>
        <div class="card-body">
            <form id="facultyForm" class="row g-3">
                <div class="col-md-3">
                    <input type="text" id="name" class="form-control" placeholder="Name" required>
                </div>
                <div class="col-md-3">
                    <input type="text" id="username" class="form-control" placeholder="Username (Unique)" pattern="[A-Za-z0-9_]{3,50}" title="3-50 letters, numbers, underscores" required>
                </div>
                <div class="col-md-3">
                    <input type="email" id="email" class="form-control" placeholder="Email (Contact)" required>
                </div>
                <div class="col-md-2">
                    <input type="text" id="department" class="form-control" placeholder="Department" required>
                </div>
                <div class="col-md-1 d-grid">
                    <button type="submit" class="btn btn-success">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
             <button class="btn btn-primary btn-sm" onclick="approveSelectedFaculty()">Approve Selected</button>
             </div>
    </div>
    
    <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white fw-bold">Faculty List</div>
        <div class="card-body">

            <div class="mb-3">
                <input type="text" id="tableSearchInput" class="form-control" placeholder="Search for faculty by name, username, email...">
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox"></th>
                            <th>Status</th>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Department</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="facultyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- NEW Toast Function ---
    function showToast(message, type = 'success') {
        const toastId = 'toast-' + Math.random().toString(36).substr(2, 9);
        const toastColor = type === 'success' ? 'bg-success' : 'bg-danger';
        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-white ${toastColor} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>`;
        
        $('#toastBox').append(toastHTML);
        const toastElement = new bootstrap.Toast(document.getElementById(toastId));
        toastElement.show();
        document.getElementById(toastId).addEventListener('hidden.bs.toast', function () {
            this.remove();
        });
    }
    
    function loadFaculty() {
        $.get("../backend/faculty.php", function(data) {
            if (data.success) {
                let tbody = $("#facultyTableBody");
                tbody.html("");
                data.faculty.forEach(faculty => {
                    let statusCell = faculty.is_approved == 1 ? '<span class="badge bg-success">Approved</span>' : '<span class="badge bg-warning text-dark">Pending</span>';
                    const facultyData = htmlspecialchars(JSON.stringify(faculty));
                    let row = `
                        <tr>
                            <td>${faculty.is_approved == 0 ? `<input type="checkbox" class="faculty-checkbox" data-id="${faculty.id}" data-username="${faculty.username}" data-email="${faculty.email}" data-name="${htmlspecialchars(faculty.name)}">` : ''}</td>
                            <td>${statusCell}</td>
                            <td>${faculty.name}</td>
                            <td>${faculty.username || ''}</td>
                            <td>${faculty.email}</td>
                            <td>${faculty.department}</td>
                            <td>
                                <button class="btn btn-warning btn-sm edit-btn" data-faculty='${facultyData}'>Edit</button>
                                <button class="btn btn-danger btn-sm delete-btn" data-id="${faculty.id}">Delete</button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else { showToast("Failed to load faculty: " + (data.error || "Unknown"), "danger"); }
        }, "json");
    }

    $("#facultyForm").submit(function(e) {
        e.preventDefault();
        $.ajax({
            url: "../backend/faculty.php", method: "POST", contentType: "application/json",
            data: JSON.stringify({
                name: $("#name").val(),
                username: $("#username").val(),
                email: $("#email").val(),
                department: $("#department").val()
            }),
            success: function(res) {
                if (res.success) {
                    loadFaculty(); $("#facultyForm")[0].reset();
                    showToast(`Faculty added. Default password: ${res.default_password}`);
                } else { showToast(res.error || "Error adding faculty", "danger"); }
            },
            error: (jqXHR) => showToast(jqXHR.responseJSON.error || "Server error.", "danger")
        });
    });

    function approveSelectedFaculty() {
        let selectedFaculty = [];
        $('.faculty-checkbox:checked').each(function() {
            selectedFaculty.push({
                id: $(this).data('id'),
                username: $(this).data('username'),
                email: $(this).data('email'),
                name: $(this).data('name')
            });
        });
        if (selectedFaculty.length === 0) { showToast("Please select at least one faculty to approve.", "danger"); return; }
        if (confirm(`Approve ${selectedFaculty.length} faculty members?`)) {
            $.ajax({
                url: '../backend/faculty.php?action=approve_bulk', method: 'POST', contentType: 'application/json',
                data: JSON.stringify({ faculty: selectedFaculty }),
                success: function(res) { 
                    if(res.success) {
                        showToast("Faculty approved!", "success");
                        loadFaculty(); 
                    }
                    else { showToast(res.error || 'Approval error', "danger"); }
                },
                error: (jqXHR) => showToast('Approval error: ' + (jqXHR.responseJSON.error || 'Check logs'), "danger")
            });
        }
    }

     $("#selectAllCheckbox").on("click", function() { $(".faculty-checkbox").prop("checked", $(this).prop("checked")); });

    $(document).on('click', '.edit-btn', function() {
        const facultyData = JSON.parse($(this).attr('data-faculty'));
        
        let newName = prompt("Enter new name:", facultyData.name);
        let newUsername = prompt("Enter new username:", facultyData.username);
        let newEmail = prompt("Enter new email:", facultyData.email);
        let newDept = prompt("Enter new department:", facultyData.department);

        if (newName !== null && newUsername !== null && newEmail !== null && newDept !== null) {
            $.ajax({
                url: "../backend/faculty.php?_method=PUT",
                method: "POST", 
                contentType: "application/json",
                data: JSON.stringify({
                    id: facultyData.id,
                    name: newName,
                    username: newUsername, 
                    email: newEmail,
                    department: newDept
                }),
                success: function(res) { 
                    if (res.success) {
                        showToast("Faculty updated.", "success");
                        loadFaculty(); 
                    }
                    else { showToast(res.error || "Error updating", "danger"); }
                }
            });
        }
    });

    $(document).on('click', '.delete-btn', function() {
        const facultyId = $(this).data('id');
        if (confirm("Delete this faculty member?")) {
            $.ajax({
                url: `../backend/faculty.php?_method=DELETE`, 
                method: "POST", 
                contentType: "application/json",
                data: JSON.stringify({ id: facultyId }), 
                success: function(res) { 
                    if (res.success) {
                        showToast("Faculty deleted.", "success");
                        loadFaculty(); 
                    }
                    else { showToast(res.error || "Error deleting", "danger"); }
                },
                error: (jqXHR) => showToast(jqXHR.responseJSON.error || "Server error.", "danger")
            });
        }
    });

    function htmlspecialchars(str) { 
        if (typeof str !== 'string') return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); 
    }

  
    $("#tableSearchInput").on("keyup", function() {
        const value = $(this).val().toLowerCase();
        $("#facultyTableBody tr").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });

    $(document).ready(loadFaculty);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>