<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Hallmate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* ... [All your CSS styles remain exactly the same] ... */
        body { background-color: #f8fafc; }
        .card {
            border-radius: 10px;
            transition: transform 0.2s ease-in-out;
            border: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,.05);
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            background-color: #0d6efd !important;
            border-radius: 10px 10px 0 0 !important;
        }
        .card-footer {
            background-color: #fff;
            border-top: 1px solid #eee;
        }
        .page-header {
            font-weight: 700;
            color: #333;
        }
        .seat-grid {
            display: grid;
            gap: 10px;
            padding: 20px;
            background-color: #f1f3f5;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            overflow-x: auto;
            max-width: fit-content;
            margin: auto;
        }
        .seat {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 5px;
            color: #495057;
            border: 1px solid #adb5bd;
            position: relative;
            box-sizing: border-box;
        }
        .seat-grid.single .seat {
            width: 50px;
            height: 50px;
        }
        .seat-grid.double .seat {
            width: 100px;
            height: 50px;
            display: flex;
            padding: 0;
            border: none;
            background-color: transparent;
        }
        .seat-grid.double .bench-side {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            border: 1px solid #adb5bd;
            background-color: #ced4da;
            box-sizing: border-box;
            border-radius: 0;
            color: #495057;
        }
        .seat-grid.double .bench-side.left { border-radius: 5px 0 0 5px; border-right: none; }
        .seat-grid.double .bench-side.right { border-radius: 0 5px 5px 0; border-left: none; }
        .seat.occupied {
            background-color: #ffffff;
            border-color: #adb5bd;
            cursor: help; 
        }
        .seat.empty {
            background-color: #ced4da;
            color: #495057;
        }
        .seat.my-seat {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.5);
        }
        .seat-grid.double .bench-side.occupied-side {
            background-color: #ffffff; 
            border-color: #adb5bd;
            cursor: help;
        }
        .seat-grid.double .bench-side.my-seat-side {
            background-color: #d4edda; 
            border-color: #28a745;
            color: #155724;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.5);
        }
        .popover {
            font-size: 0.85rem;
        }
        .popover-header {
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-light">

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="page-header">Student Dashboard</h1>
      <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
    </div>

    <div id="examsContainer" class="row g-4">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading your exams...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="seatingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="seatingModalTitle">Seating Layout</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
            <span class="badge bg-success me-2">My Seat</span>
            <span class="badge bg-secondary">Empty</span>
        </div>
        <div id="seatMapContainer" class="d-flex justify-content-center">
            <div class="spinner-border" role="status"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    async function loadExams() {
        // ... [This function is unchanged] ...
        try {
            const response = await fetch('../backend/student_dashboard.php');
            const data = await response.json();
            const examsContainer = document.getElementById('examsContainer');
            examsContainer.innerHTML = ''; 

            if (data.success) {
                if (data.exams && data.exams.length > 0) {
                    data.exams.forEach(exam => {
                        const card = `
                        <div class="col-md-6 col-lg-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header text-white" style="background-color: #6f42c1 !important;">
                                    <h5 class="card-title mb-0">${exam.subject}</h5>
                                    <p class="card-subtitle text-white-50">${exam.course_code}</p>
                                </div>
                                <div class="card-body">
                                    <p class="mb-1"><strong><i class="bi bi-calendar-event"></i> Date:</strong> ${exam.exam_date}</p>
                                    <p class="mb-1"><strong><i class="bi bi-clock"></i> Session:</strong> ${exam.session}</p>
                                    <p class="mb-1"><strong><i class="bi bi-geo-alt"></i> Room:</strong> ${exam.room_no} (${exam.room_details || ''})</p>
                                    <p class="mb-0"><strong><i class="bi bi-journal-text"></i> Seat:</strong> <span class="fw-bold text-success">${exam.seat_no || 'Not Assigned'}</span></p>
                                </div>
                                <div class="card-footer d-flex justify-content-end">
                                    ${exam.seat_no ? `<button class="btn btn-primary btn-sm" onclick="showStudentSeatingMap(${exam.room_id}, ${exam.exam_id}, '${exam.room_no}', '${exam.seat_no}')">
                                        <i class="bi bi-grid-3x3-gap-fill"></i> View Seating Map
                                    </button>` : `<span class="badge bg-warning">Seat Not Assigned</span>`}
                                </div>
                            </div>
                        </div>`;
                        examsContainer.innerHTML += card;
                    });
                } else {
                    examsContainer.innerHTML = '<div class="col-12"><div class="alert alert-info text-center">No exams scheduled for you.</div></div>';
                }
            } else {
                if (response.status === 401) {
                    window.location.href = "login.html";
                } else {
                    alert('Error: ' + data.error);
                }
            }
        } catch (error) {
            console.error('Failed to load exams:', error);
            alert('A network error occurred. Please try again.');
        }
    }

    async function showStudentSeatingMap(roomId, examId, roomName, mySeatNo) {
        const modal = new bootstrap.Modal(document.getElementById('seatingModal'));
        const title = document.getElementById('seatingModalTitle');
        const container = document.getElementById('seatMapContainer');

        title.textContent = `Seating Layout for Room: ${roomName}`;
        container.innerHTML = '<div class="spinner-border text-primary" role="status"></div>';
        modal.show();

        try {
            const response = await fetch(`../backend/get_room_layout.php?room_id=${roomId}&exam_id=${examId}`);
            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            
            // ---
            // --- ðŸ’¡ NEW PRIVACY FIX: Only show the student's *own* seat ðŸ’¡ ---
            // ---
            const myAllocation = data.allocations.find(alloc => alloc.seat_no === mySeatNo);
            data.allocations = myAllocation ? [myAllocation] : []; // Re-assign array to only contain the student's seat
            // --- END OF FIX ---


            // --- FIX: CALCULATE ROW/COL FROM SEAT_NO ---
            const totalCols = data.room.total_cols;
            data.allocations.forEach(alloc => {
                const parts = alloc.seat_no.split('-'); 
                if (parts.length >= 2) {
                    const seatNum = parseInt(parts[1]); 
                    if (!isNaN(seatNum)) {
                        alloc.seat_row = Math.floor((seatNum - 1) / totalCols) + 1;
                        alloc.seat_col = ((seatNum - 1) % totalCols) + 1;
                    }
                }
            });
            // --- END OF FIX ---


            container.innerHTML = ""; 
            const grid = document.createElement('div');
            grid.className = 'seat-grid';
            
            grid.style.gridTemplateColumns = `repeat(${data.room.total_cols}, 1fr)`;
            grid.classList.add(data.room.seating_type); 

            // Build a lookup map (This will now only contain one seat)
            const occupiedSeats = {};
            data.allocations.forEach(alloc => {
                const baseKey = `${alloc.seat_row}_${alloc.seat_col}`;
                if (data.room.seating_type === 'single') {
                    occupiedSeats[baseKey] = alloc;
                } else if (data.room.seating_type === 'double') {
                    const side = alloc.seat_no.endsWith('-L') ? 'L' : 'R';
                    occupiedSeats[`${baseKey}_${side}`] = alloc;
                }
            });

            // Loop through the grid coordinates
            for (let r = 1; r <= data.room.total_rows; r++) {
                for (let c = 1; c <= data.room.total_cols; c++) {
                    const seatDiv = document.createElement('div');
                    seatDiv.className = 'seat'; 

                    if (data.room.seating_type === 'single') {
                        const seatKey = `${r}_${c}`;
                        const alloc = occupiedSeats[seatKey];
                        
                        if (alloc) { // This will only be true for the student's own seat
                            seatDiv.textContent = alloc.seat_no.split('-').pop();
                            seatDiv.classList.add('occupied');
                            if (alloc.seat_no === mySeatNo) {
                                seatDiv.classList.add('my-seat');
                            }
                            addPopover(seatDiv, alloc);
                        } else {
                            seatDiv.textContent = `Empty`; 
                            seatDiv.classList.add('empty');
                        }
                    } else if (data.room.seating_type === 'double') {
                        const benchKey = `${r}_${c}`;
                        const seatL = occupiedSeats[`${benchKey}_L`];
                        const seatR = occupiedSeats[`${benchKey}_R`];

                        // Create Left side
                        const benchL = document.createElement('div');
                        benchL.className = 'bench-side left';
                        if (seatL) { // Only true for student's seat
                            benchL.textContent = seatL.seat_no.split('-').pop();
                            benchL.classList.add('occupied-side');
                            if (seatL.seat_no === mySeatNo) {
                                benchL.classList.add('my-seat-side');
                            }
                            addPopover(benchL, seatL);
                        } else {
                            benchL.textContent = `Empty L`;
                        }
                        seatDiv.appendChild(benchL);

                        // Create Right side
                        const benchR = document.createElement('div');
                        benchR.className = 'bench-side right';
                        if (seatR) { // Only true for student's seat
                            benchR.textContent = seatR.seat_no.split('-').pop();
                            benchR.classList.add('occupied-side');
                            if (seatR.seat_no === mySeatNo) {
                                benchR.classList.add('my-seat-side');
                            }
                            addPopover(benchR, seatR);
                        } else {
                            benchR.textContent = `Empty R`;
                        }
                        seatDiv.appendChild(benchR);
                    }
                    grid.appendChild(seatDiv);
                }
            }
            container.appendChild(grid);
            
            // Initialize all new popovers
            const popoverTriggerList = [].slice.call(container.querySelectorAll('[data-bs-toggle="popover"]'));
            popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl, { trigger: 'hover' });
            });

        } catch (error) {
            console.error("Error fetching seating map:", error);
            container.innerHTML = `<div class="alert alert-danger">Error loading map: ${error.message}</div>`;
        }
    }

    function addPopover(element, alloc) {
        // ... [This function is unchanged] ...
        const studentName = alloc.student_name || 'Unknown Student'; 
        
        element.setAttribute('data-bs-toggle', 'popover');
        element.setAttribute('data-bs-trigger', 'hover');
        element.setAttribute('data-bs-placement', 'top');
        element.setAttribute('data-bs-title', `Seat: ${alloc.seat_no}`);
        element.setAttribute('data-bs-content', `Student: ${studentName} (ID: ${alloc.student_id})`);
    }

    function logout() {
        // ... [This function is unchanged] ...
        fetch('../backend/logout.php')
            .then(() => {
                window.location.href = 'login.html';
            });
    }

    document.addEventListener('DOMContentLoaded', loadExams);
</script>
</body>
</html>